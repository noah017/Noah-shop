<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Noah Shop</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Estilos CSS */
        body {
            background-color: #222222; 
            color: #FFFFFF;
            margin: 0;
            padding: 20px; 
            font-family: Arial, sans-serif;
        }
        h2 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #333333;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #444;
            color: white;
            box-sizing: border-box;
        }
        input:read-only {
            background-color: #555; 
        }
        .row {
            display: flex;
            gap: 15px;
        }
        .row > div {
            flex: 1;
        }
        .buy-button {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1.1em;
            margin-top: 20px;
        }
        .buy-button:hover {
            background-color: #45A049;
        }
    </style>
</head>
<body>

    <div class="form-container">
        <h2><i class="fas fa-truck"></i> Dados de Entrega e Pagamento</h2>
        <form method="POST" action="/comprar"> 

            <p style="text-align: center; color: #FFD700; border-bottom: 1px solid #4CAF50; padding-bottom: 10px;">
                Você está comprando: <strong id="produtoNomeDisplay">...</strong>
            </p>

            <label for="nome">Nome Completo do Recebedor:</label>
            <input type="text" id="nome" name="nome" required>
            
            <label for="telefone">Telefone (DDD + Número):</label>
            <input type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999" required>

            <label for="cep">CEP:</label>
            <input type="text" id="cep" name="cep" placeholder="Digite seu CEP (ex: 14847144)" maxlength="8" required onblur="consultarCEP(this.value)">

            <label for="logradouro">Logradouro (Rua/Avenida):</label>
            <input type="text" id="logradouro" name="logradouro" readonly>

            <div class="row">
                <div>
                    <label for="numero">Número da Casa:</label>
                    <input type="text" id="numero" name="numero" required>
                </div>
                <div>
                    <label for="bairro">Bairro:</label>
                    <input type="text" id="bairro" name="bairro" readonly>
                </div>
            </div>

            <label for="cidade">Cidade:</label>
            <input type="text" id="cidade" name="cidade" readonly>

            <label for="estado">Estado (UF):</label>
            <input type="text" id="estado" name="estado" readonly>
            
            <input type="hidden" id="valorTotal" name="valorTotal" value="">
            <input type="hidden" id="produtoNome" name="produtoNome" value="">

            <button type="submit" class="buy-button">Gerar PIX e Finalizar</button>

        </form>
    </div>

    <script>
        // Variáveis de URL e Lógica de Setup
        const urlParams = new URLSearchParams(window.location.search);
        const valorUrl = urlParams.get('valor');
        const produtoUrl = urlParams.get('produto');
        
        // Inicializa o valor e o nome do produto no formulário (visível e oculto)
        if (valorUrl && produtoUrl) {
            document.getElementById('valorTotal').value = valorUrl;
            document.getElementById('produtoNome').value = produtoUrl;
            document.getElementById('produtoNomeDisplay').textContent = produtoUrl.replace(/\+/g, ' ');
        } else {
            document.getElementById('produtoNomeDisplay').textContent = "ERRO: Produto não selecionado";
            document.getElementById('valorTotal').value = "0.00";
        }
        
        // Função de Consulta de CEP (ViaCEP)
        function consultarCEP(cep) {
            cep = cep.replace(/\D/g, ''); 
            if (cep.length != 8) return;

            const url = `https://viacep.com.br/ws/${cep}/json/`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!("erro" in data)) {
                        document.getElementById('logradouro').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                        document.getElementById('cidade').value = data.localidade;
                        document.getElementById('estado').value = data.uf;
                        document.getElementById('numero').focus();
                    } else {
                        alert("CEP não encontrado. Preencha o endereço manualmente.");
                    }
                })
                .catch(error => {
                    console.error('Erro ao consultar CEP:', error);
                    alert("Erro na consulta do CEP. Tente novamente ou preencha manualmente.");
                });
        }
        
    </script>
</body>
</html>
